<!doctype html>
<meta charset="utf-8" />
<title>QR-Sign Stats</title>

<h1 id="msg">Loading…</h1>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onDisconnect, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
import { getFirestore, doc, runTransaction, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/*  ← paste your own config object from the console */
const firebaseConfig = {
  apiKey: "…",
  authDomain: "borderland-qr.firebaseapp.com",
  projectId: "borderland-qr",
  databaseURL: "https://borderland-qr-default-rtdb.europe-west1.firebasedatabase.app",
};
initializeApp(firebaseConfig);

const db  = getDatabase();
const fs  = getFirestore();
const h1  = document.getElementById("msg");
const id  = crypto.randomUUID();
const TTL = 30_000;                        // ms counted as “online”

/* ---- presence in Realtime DB ---- */
const presRef = ref(db, `status/${id}`);
set(presRef, { ts: Date.now() });
onDisconnect(presRef).remove();
setInterval(() => set(presRef, { ts: Date.now() }), TTL - 5_000);

let online = 0;
onValue(ref(db, "status"), snap => {
  online = snap.size || snap.numChildren();
  render();
});

/* ---- totals + lastSeen in Firestore ---- */
const statDoc = doc(fs, "stats/global");
let total = 0, lastSeen = 0;

await runTransaction(fs, async tx => {
  const s = await tx.get(statDoc);
  const d = s.exists() ? s.data() : { total: 0, lastSeen: 0 };
  total    = d.total + 1;
  lastSeen = Date.now();
  tx.set(statDoc, { total, lastSeen });
});
onSnapshot(statDoc, snap => {
  ({ total, lastSeen } = snap.data());
  render();
});

/* ---- view ---- */
function minsAgo(t) {
  const m = Math.floor((Date.now() - t) / 60_000);
  return `${m} minute${m !== 1 ? "s" : ""} ago`;
}
function render() {
  if (online > 1) {
    h1.textContent = `${online} people are looking at this instead of experiencing literally everything.`;
  } else {
    h1.textContent = `The last person to scan this sign was here ${minsAgo(lastSeen)}. ${total} people have scanned the sign.`;
  }
}
</script>
